name: Generar Markdown desde PDFs

on:
  workflow_dispatch:
    inputs:
      ruta_pdf:
        description: "Directorio donde buscar PDFs (por defecto data/general)"
        required: false
        default: "data/general"

permissions:
  contents: read
  actions: write

jobs:
  convertir:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Instalar markitdown
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir markitdown==0.1.4

      - name: Convertir PDFs a Markdown
        shell: bash
        env:
          PDF_ROOT: ${{ github.event.inputs.ruta_pdf }}
        run: |
          set -u
          set -o pipefail

          workspace_root="$(pwd -P)"
          raiz="${PDF_ROOT:-data/general}"
          raiz="${raiz%/}"
          if [ ! -d "$raiz" ]; then
            echo "El directorio ${raiz} no existe."
            exit 0
          fi

          if ! raiz_abs="$(realpath "$raiz")"; then
            echo "No se pudo resolver la ruta absoluta de ${raiz}."
            exit 1
          fi
          case "$raiz_abs" in
            "$workspace_root"|"$workspace_root"/*)
              ;;
            *)
              echo "La ruta ${raiz} debe estar dentro del repositorio clonado."
              exit 1
              ;;
          esac
          if [ "$raiz_abs" = "$workspace_root" ]; then
            echo "Debe especificarse un directorio diferente a la raíz del repositorio."
            exit 1
          fi
          echo "OUTPUT_ROOT=${raiz_abs}" >> "$GITHUB_ENV"
          raiz="$raiz_abs"

          listado_pdf="$(mktemp)"
          if ! find "$raiz" -type f -name '*.pdf' -print0 > "$listado_pdf"; then
            echo "Error al buscar archivos PDF en ${raiz}." >&2
            rm -f "$listado_pdf"
            exit 1
          fi
          pdf_files=()
          if [ -s "$listado_pdf" ]; then
            mapfile -d '' pdf_files < "$listado_pdf"
          fi
          rm -f "$listado_pdf"

          if [ ${#pdf_files[@]} -eq 0 ]; then
            echo "No se encontraron archivos PDF en ${raiz}."
            exit 0
          fi

          generated_files=()
          for file in "${pdf_files[@]}"; do
            output="${file%.pdf}.md"
            echo "Convirtiendo $file a $output"
            tmp_error="$(mktemp)"
            if ! markitdown "$file" > "$output" 2>"$tmp_error"; then
              echo "Error al convertir $file; se continúa con el siguiente." >&2
              cat "$tmp_error" >&2
            else
              generated_files+=("$output")
            fi
            rm -f "$tmp_error"
          done

          if [ ${#generated_files[@]} -gt 0 ]; then
            markdown_json="$(printf '%s\n' "${generated_files[@]}" | python - <<'PY'
import json
import sys

paths = [line.rstrip("\n") for line in sys.stdin if line.strip()]
print(json.dumps(paths))
PY
)"
            echo "MARKDOWN_PATHS=${markdown_json}" >> "$GITHUB_ENV"
          fi

      - name: Publicar artefacto
        uses: actions/upload-artifact@v4
        if: env.MARKDOWN_PATHS != ''
        with:
          name: markdown-desde-pdfs
          path: ${{ fromJSON(env.MARKDOWN_PATHS) }}
