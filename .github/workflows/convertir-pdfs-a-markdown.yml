name: Generar Markdown desde PDFs

on:
  workflow_dispatch:
    inputs:
      ruta_pdf:
        description: "Directorio donde buscar PDFs (por defecto docs/)"
        required: false
        default: "docs"

permissions:
  contents: read
  actions: write

jobs:
  convertir:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Instalar markitdown
        run: |
          python -m pip install --upgrade pip
          python -m pip install --no-cache-dir markitdown==0.1.4

      - name: Convertir PDFs a Markdown
        shell: bash
        env:
          PDF_ROOT: ${{ github.event.inputs.ruta_pdf }}
        run: |
          set -u
          set -o pipefail

          raiz="${PDF_ROOT:-docs}"
          raiz="${raiz%/}"
          if [ -z "$raiz" ]; then
            raiz="."
          fi
          raiz_con_slash="${raiz}/"
          mkdir -p markdown
          if [ ! -d "$raiz" ]; then
            echo "El directorio ${raiz} no existe." | tee markdown/README.md
            exit 0
          fi

          listado_pdf="$(mktemp)"
          if ! find "$raiz" -type f -name '*.pdf' -print0 > "$listado_pdf"; then
            echo "Error al buscar archivos PDF en ${raiz}." >&2
            rm -f "$listado_pdf"
            exit 1
          fi
          pdf_files=()
          if [ -s "$listado_pdf" ]; then
            mapfile -d '' pdf_files < "$listado_pdf"
          fi
          rm -f "$listado_pdf"

          if [ ${#pdf_files[@]} -eq 0 ]; then
            echo "No se encontraron archivos PDF en ${raiz}." | tee markdown/README.md
            exit 0
          fi

          for file in "${pdf_files[@]}"; do
            relative="${file#"$raiz_con_slash"}"
            relative="${relative#./}"
            output="markdown/${relative%.pdf}.md"
            mkdir -p "$(dirname "$output")"
            echo "Convirtiendo $file a $output"
            tmp_error="$(mktemp)"
            if ! markitdown "$file" > "$output" 2>"$tmp_error"; then
              echo "Error al convertir $file; se continÃºa con el siguiente." >&2
              cat "$tmp_error" >&2
            fi
            rm -f "$tmp_error"
          done

      - name: Publicar artefacto
        uses: actions/upload-artifact@v4
        with:
          name: markdown-desde-pdfs
          path: markdown
